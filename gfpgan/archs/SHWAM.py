import torch
import math
import torch.nn as nn
import torch.nn.functional as F


class BasicConv(nn.Module):
    def __init__(self, in_planes, out_planes, kernel_size, stride=1, padding=0, dilation=1, groups=1, relu=True,
                 bn=True, bias=False):
        super(BasicConv, self).__init__()
        self.out_channels = out_planes
        self.conv = nn.Conv2d(in_planes, out_planes, kernel_size=kernel_size, stride=stride, padding=padding,
                              dilation=dilation, groups=groups, bias=bias)
        self.bn = nn.BatchNorm2d(out_planes, eps=1e-5, momentum=0.01, affine=True) if bn else None
        self.relu = nn.ReLU() if relu else None

    def forward(self, x):
        x = self.conv(x)
        if self.bn is not None:
            x = self.bn(x)
        if self.relu is not None:
            x = self.relu(x)
        return x


class Flatten(nn.Module):
    def forward(self, x):
        return x.view(x.size(0), -1)


class ChannelGate(nn.Module):
    def __init__(self, gate_channels, reduction_ratio=16, pool_type='avgH', flag=False):
        super(ChannelGate, self).__init__()
        self.gate_channels = gate_channels
        if flag:
            num_feat = 8192 * 2 // gate_channels
        else:
            num_feat = 8192 // gate_channels
        self.mlp1 = nn.Sequential(
            nn.Linear(num_feat, num_feat // reduction_ratio),
            nn.ReLU(inplace=True),
            nn.Linear(num_feat // reduction_ratio, num_feat)
        )
        self.mlp2 = nn.Sequential(
            nn.Linear(num_feat, num_feat // reduction_ratio),
            nn.ReLU(inplace=True),
            nn.Linear(num_feat // reduction_ratio, num_feat)
        )
        # self.mlp_conv = nn.Sequential(
        #     nn.Conv1d(num_feat, num_feat // reduction_ratio, 1, bias=False),
        #     nn.ReLU(inplace=True),
        #     nn.Conv1d(num_feat // reduction_ratio, num_feat, 1, bias=False)
        #     )
        self.pool_type = pool_type

    def forward(self, x):
        if self.pool_type == 'avgH':
            x_in = x
            avg_pool = torch.mean(x_in, dim=3)
            channel_att_raw = [self.mlp1(s) for s in [avg_pool]]
            # channel_att_raw = [self.mlp_conv(avg_pool)]
            # channel_att_raw = self.mlp(avg_pool)
            channel_att_sum = channel_att_raw[0]
            scale = F.sigmoid(channel_att_sum).unsqueeze(3).expand_as(x)
            return x * scale

        elif self.pool_type == 'avgW':
            x_in = x
            avg_pool = torch.mean(x_in, dim=2)
            channel_att_raw = [self.mlp2(s) for s in [avg_pool]]
            # channel_att_raw = self.mlp(avg_pool)
            channel_att_sum = channel_att_raw[0]
            scale = F.sigmoid(channel_att_sum).unsqueeze(2).expand_as(x)
            return x * scale


def logsumexp_2d(tensor):
    tensor_flatten = tensor.view(tensor.size(0), tensor.size(1), -1)
    s, _ = torch.max(tensor_flatten, dim=2, keepdim=True)
    outputs = s + (tensor_flatten - s).exp().sum(dim=2, keepdim=True).log()
    return outputs


class ChannelPool(nn.Module):
    def forward(self, x):
        max_out, _ = torch.max(x, dim=1, keepdim=True)
        avg_out = torch.mean(x, dim=1, keepdim=True)
        return torch.cat((max_out, avg_out), dim=1)


class SpatialGate(nn.Module):
    def __init__(self, in_channels):
        super(SpatialGate, self).__init__()
        kernel_size = 7
        self.compress = ChannelPool()
        self.conv = BasicConv(in_channels, in_channels * 2, 3, stride=1, padding=1, relu=False)
        # self.spatial = BasicConv(in_channels * 2, in_channels, kernel_size, stride=1, padding=(kernel_size-1) // 2,
        #                          relu=False)
        self.spatial = BasicConv(2, 1, kernel_size, stride=1, padding=(kernel_size - 1) // 2, relu=False)

    def forward(self, x):
        x_compress = self.compress(x)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          # x_compress = self.conv(x)
        x_out = self.spatial(x_compress)
        scale = F.sigmoid(x_out)  # broadcasting
        return x * scale


class SHWAM(nn.Module):
    def __init__(self, gate_channels, reduction_ratio=16, pool_types=['avgW', 'avgH'], flag=False):
        super(SHWAM, self).__init__()
        if flag:
            self.ChannelGateW = ChannelGate(gate_channels, reduction_ratio, pool_types[0], flag=flag)
            self.ChannelGateH = ChannelGate(gate_channels, reduction_ratio, pool_types[1], flag=flag)
        else:
            self.ChannelGateW = ChannelGate(gate_channels, reduction_ratio, pool_types[0])
            self.ChannelGateH = ChannelGate(gate_channels, reduction_ratio, pool_types[1])
        # ffn_expansion_factor = 2.66
        # hidden_features = int(gate_channels * ffn_expansion_factor)
        #
        # self.project_in = nn.Conv2d(gate_channels, hidden_features * 2, kernel_size=1, bias=False)
        #
        # self.dwconv = nn.Conv2d(hidden_features * 2, hidden_features * 2, kernel_size=3, stride=1, padding=1,
        #                         groups=hidden_features * 2, bias=False)
        # self.project_out = nn.Conv2d(hidden_features, gate_channels, kernel_size=1, bias=False)

        # spatial_kernel = 7
        # self.conv = BasicConv(gate_channels, gate_channels * 2, 3, stride=1, padding=1, relu=False)
        # self.spatial = nn.Conv2d(2, 1, kernel_size=spatial_kernel,
        #                          padding=spatial_kernel // 2, bias=False)
        # self.sigmoid = nn.Sigmoid()

        # self.skip1 = nn.Conv2d(gate_channels, gate_channels, 1, stride=1, padding=0)
        # self.skip2 = nn.Conv2d(gate_channels, gate_channels, 1, stride=1, padding=0)

    def forward(self, x):
        # x_in = self.project_in(x)
        # x1, x2 = self.dwconv(x_in).chunk(2, dim=1)
        # x_in = F.gelu(x1) * x2
        # x_in = self.project_out(x_in)

        # x_out = x_in + self.skip1(x)

        x_out = self.ChannelGateW(x)
        x_out = self.ChannelGateH(x_out)
        # x_out = x_out + self.skip1(x)

        # max_out, _ = torch.max(x, dim=1, keepdim=True)
        # avg_out = torch.mean(x, dim=1, keepdim=True)
        # # spatial_out = self.sigmoid(self.spatial(self.conv(x_out)))
        # spatial_out = self.sigmoid(self.spatial(torch.cat([max_out, avg_out], dim=1)))
        # x_out = spatial_out * x_out

        # x_out = x_out + self.skip2(x)

        return x_out


class SHWAM73(nn.Module):
    def __init__(self, gate_channels, reduction_ratio=16, pool_types=['avgW', 'avgH'], flag=False):
        super(SHWAM73, self).__init__()
        if flag:
            self.ChannelGateW = ChannelGate(gate_channels, reduction_ratio, pool_types[0], flag=flag)
            self.ChannelGateH = ChannelGate(gate_channels, reduction_ratio, pool_types[1], flag=flag)
        else:
            self.ChannelGateW = ChannelGate(gate_channels, reduction_ratio, pool_types[0])
            self.ChannelGateH = ChannelGate(gate_channels, reduction_ratio, pool_types[1])
        # ffn_expansion_factor = 2.66
        # hidden_features = int(gate_channels * ffn_expansion_factor)
        #
        # self.project_in = nn.Conv2d(gate_channels, hidden_features * 2, kernel_size=1, bias=False)
        #
        # self.dwconv = nn.Conv2d(hidden_features * 2, hidden_features * 2, kernel_size=3, stride=1, padding=1,
        #                         groups=hidden_features * 2, bias=False)
        # self.project_out = nn.Conv2d(hidden_features, gate_channels, kernel_size=1, bias=False)

        spatial_kernel = 3
        self.conv = BasicConv(gate_channels, gate_channels * 2, 3, stride=1, padding=1, relu=False)
        self.spatial1 = nn.Conv2d(2, 1, kernel_size=spatial_kernel,
                                  padding=spatial_kernel // 2, bias=False)
        self.spatial2 = nn.Conv2d(1, 1, kernel_size=spatial_kernel,
                                  padding=spatial_kernel // 2, bias=False)
        self.spatial3 = nn.Conv2d(1, 1, kernel_size=spatial_kernel,
                                  padding=spatial_kernel // 2, bias=False)
        self.sigmoid = nn.Sigmoid()

        self.skip1 = nn.Conv2d(gate_channels, gate_channels, 1, stride=1, padding=0)
        self.skip2 = nn.Conv2d(gate_channels, gate_channels, 1, stride=1, padding=0)

    def forward(self, x):
        # x_in = self.project_in(x)
        # x1, x2 = self.dwconv(x_in).chunk(2, dim=1)
        # x_in = F.gelu(x1) * x2
        # x_in = self.project_out(x_in)

        # x_out = x_in + self.skip1(x)

        x_out = self.ChannelGateW(x)
        x_out = x_out + self.skip1(x)
        x_out = self.ChannelGateH(x_out)
        x_out = x_out + self.skip2(x)

        max_out, _ = torch.max(x, dim=1, keepdim=True)
        avg_out = torch.mean(x, dim=1, keepdim=True)
        # spatial_out = self.sigmoid(self.spatial(self.conv(x_out)))
        spatial_out = self.sigmoid(self.spatial3(self.spatial2(self.spatial1(torch.cat([max_out, avg_out], dim=1)))))
        x_out = spatial_out * x_out

        # x_out = x_out + self.skip2(x)

        return x_out


class ReSHWAM(nn.Module):
    def __init__(self, gate_channels, reduction_ratio=16, pool_types=['avgW', 'avgH'], flag=False):
        super(ReSHWAM, self).__init__()
        if flag:
            self.ChannelGateW = ChannelGate(gate_channels, reduction_ratio, pool_types[0], flag=flag)
            self.ChannelGateH = ChannelGate(gate_channels, reduction_ratio, pool_types[1], flag=flag)
        else:
            self.ChannelGateW = ChannelGate(gate_channels, reduction_ratio, pool_types[0])
            self.ChannelGateH = ChannelGate(gate_channels, reduction_ratio, pool_types[1])
        # ffn_expansion_factor = 2.66
        # hidden_features = int(gate_channels * ffn_expansion_factor)
        #
        # self.project_in = nn.Conv2d(gate_channels, hidden_features * 2, kernel_size=1, bias=False)
        #
        # self.dwconv = nn.Conv2d(hidden_features * 2, hidden_features * 2, kernel_size=3, stride=1, padding=1,
        #                         groups=hidden_features * 2, bias=False)
        # self.project_out = nn.Conv2d(hidden_features, gate_channels, kernel_size=1, bias=False)

        spatial_kernel = 7
        self.conv = BasicConv(gate_channels, gate_channels * 2, 3, stride=1, padding=1, relu=False)
        self.spatial = nn.Conv2d(2, 1, kernel_size=spatial_kernel,
                                 padding=spatial_kernel // 2, bias=False)
        self.sigmoid = nn.Sigmoid()

        self.skip1 = nn.Conv2d(gate_channels, gate_channels, 1, stride=1, padding=0)
        self.skip2 = nn.Conv2d(gate_channels, gate_channels, 1, stride=1, padding=0)

    def forward(self, x):
        # x_in = self.project_in(x)
        # x1, x2 = self.dwconv(x_in).chunk(2, dim=1)
        # x_in = F.gelu(x1) * x2
        # x_in = self.project_out(x_in)

        # x_out = x_in + self.skip1(x)

        x_out = self.ChannelGateW(x)
        x_out = x_out + self.skip1(x)
        x_out = self.ChannelGateH(x_out)
        x_out = x_out + self.skip2(x)

        max_out, _ = torch.max(x, dim=1, keepdim=True)
        avg_out = torch.mean(x, dim=1, keepdim=True)
        # spatial_out = self.sigmoid(self.spatial(self.conv(x_out)))
        spatial_out = self.sigmoid(self.spatial(torch.cat([max_out, avg_out], dim=1)))
        x_out = spatial_out * x_out

        # x_out = x_out + self.skip2(x)

        return x_out


class ReSHWAM73(nn.Module):
    def __init__(self, gate_channels, reduction_ratio=16, pool_types=['avgW', 'avgH'], flag=False):
        super(ReSHWAM73, self).__init__()
        if flag:
            self.ChannelGateW = ChannelGate(gate_channels, reduction_ratio, pool_types[0], flag=flag)
            self.ChannelGateH = ChannelGate(gate_channels, reduction_ratio, pool_types[1], flag=flag)
        else:
            self.ChannelGateW = ChannelGate(gate_channels, reduction_ratio, pool_types[0])
            self.ChannelGateH = ChannelGate(gate_channels, reduction_ratio, pool_types[1])
        # ffn_expansion_factor = 2.66
        # hidden_features = int(gate_channels * ffn_expansion_factor)
        #
        # self.project_in = nn.Conv2d(gate_channels, hidden_features * 2, kernel_size=1, bias=False)
        #
        # self.dwconv = nn.Conv2d(hidden_features * 2, hidden_features * 2, kernel_size=3, stride=1, padding=1,
        #                         groups=hidden_features * 2, bias=False)
        # self.project_out = nn.Conv2d(hidden_features, gate_channels, kernel_size=1, bias=False)

        spatial_kernel = 3
        self.conv = BasicConv(gate_channels, gate_channels * 2, 3, stride=1, padding=1, relu=False)
        self.spatial1 = nn.Conv2d(2, 1, kernel_size=spatial_kernel,
                                  padding=spatial_kernel // 2, bias=False)
        self.spatial2 = nn.Conv2d(1, 1, kernel_size=spatial_kernel,
                                  padding=spatial_kernel // 2, bias=False)
        self.spatial3 = nn.Conv2d(1, 1, kernel_size=spatial_kernel,
                                  padding=spatial_kernel // 2, bias=False)
        self.sigmoid = nn.Sigmoid()

        self.skip1 = nn.Conv2d(gate_channels, gate_channels, 1, stride=1, padding=0)
        # self.skip2 = nn.Conv2d(gate_channels, gate_channels, 1, stride=1, padding=0)

    def forward(self, x):
        # x_in = self.project_in(x)
        # x1, x2 = self.dwconv(x_in).chunk(2, dim=1)
        # x_in = F.gelu(x1) * x2
        # x_in = self.project_out(x_in)

        # x_out = x_in + self.skip1(x)

        x_out = self.ChannelGateW(x)
        x_out = self.ChannelGateH(x_out)
        x_out = x_out + self.skip1(x)

        max_out, _ = torch.max(x_out, dim=1, keepdim=True)
        avg_out = torch.mean(x_out, dim=1, keepdim=True)
        # spatial_out = self.sigmoid(self.spatial(self.conv(x_out)))
        spatial_out = self.sigmoid(self.spatial3(self.spatial2(self.spatial1(torch.cat([max_out, avg_out], dim=1)))))
        x_out = spatial_out * x_out

        # x_out = x_out + self.skip2(x)

        return x_out


class CBAMLayer(nn.Module):
    def __init__(self, channel, reduction=16, spatial_kernel=7):
        super(CBAMLayer, self).__init__()

        # channel attention 压缩H,W为1
        self.max_pool = nn.AdaptiveMaxPool2d(1)
        self.avg_pool = nn.AdaptiveAvgPool2d(1)

        # shared MLP
        self.mlp = nn.Sequential(
            # Conv2d比Linear方便操作
            # nn.Linear(channel, channel // reduction, bias=False)
            nn.Conv2d(channel, channel // reduction, 1, bias=False),
            # inplace=True直接替换，节省内存
            nn.ReLU(inplace=True),
            # nn.Linear(channel // reduction, channel,bias=False)
            nn.Conv2d(channel // reduction, channel, 1, bias=False)
        )

        # spatial attention
        self.conv = nn.Conv2d(2, 1, kernel_size=spatial_kernel,
                              padding=spatial_kernel // 2, bias=False)
        self.sigmoid = nn.Sigmoid()

    def forward(self, x):
        # max_out = self.mlp(self.max_pool(x))
        # avg_out = self.mlp(self.avg_pool(x))
        # channel_out = self.sigmoid(max_out + avg_out)
        # x = channel_out * x

        max_out, _ = torch.max(x, dim=1, keepdim=True)
        avg_out = torch.mean(x, dim=1, keepdim=True)
        spatial_out = self.sigmoid(self.conv(torch.cat([max_out, avg_out], dim=1)))
        x = spatial_out * x
        return x


class ResHWAM(nn.Module):
    def __init__(self, gate_channels, reduction_ratio=16, pool_types=['avgW', 'avgH'], flag=False):
        super(ResHWAM, self).__init__()
        if flag:
            self.ChannelGateW = ChannelGate(gate_channels, reduction_ratio, pool_types[0], flag=flag)
            self.ChannelGateH = ChannelGate(gate_channels, reduction_ratio, pool_types[1], flag=flag)
        else:
            self.ChannelGateW = ChannelGate(gate_channels, reduction_ratio, pool_types[0])
            self.ChannelGateH = ChannelGate(gate_channels, reduction_ratio, pool_types[1])

        # self.skip1 = nn.Conv2d(gate_channels, gate_channels, 1, stride=1, padding=0)
        # self.skip2 = nn.Conv2d(gate_channels, gate_channels, 1, stride=1, padding=0)

    def forward(self, x):
        x_out = self.ChannelGateW(x)
        # x_out = x_out + self.skip1(x)
        x_out = self.ChannelGateH(x_out)
        # x_out = x_out + self.skip2(x)

        return x_out


class WAM(nn.Module):
    def __init__(self, gate_channels, reduction_ratio=16, pool_types=['avgW'], flag=False):
        super(WAM, self).__init__()
        if flag:
            self.ChannelGateW = ChannelGate(gate_channels, reduction_ratio, pool_types[0], flag=flag)
            # self.ChannelGateH = ChannelGate(gate_channels, reduction_ratio, pool_types[1], flag=flag)
        else:
            self.ChannelGateW = ChannelGate(gate_channels, reduction_ratio, pool_types[0])
            # self.ChannelGateH = ChannelGate(gate_channels, reduction_ratio, pool_types[1])

        # self.skip1 = nn.Conv2d(gate_channels, gate_channels, 1, stride=1, padding=0)
        # self.skip2 = nn.Conv2d(gate_channels, gate_channels, 1, stride=1, padding=0)

    def forward(self, x):
        x_out = self.ChannelGateW(x)
        # x_out = x_out + self.skip1(x)
        # x_out = self.ChannelGateH(x_out)
        # x_out = x_out + self.skip2(x)

        return x_out


class ResWAM(nn.Module):
    def __init__(self, gate_channels, reduction_ratio=16, pool_types=['avgW'], flag=False):
        super(ResWAM, self).__init__()
        if flag:
            self.ChannelGateW = ChannelGate(gate_channels, reduction_ratio, pool_types[0], flag=flag)
            # self.ChannelGateH = ChannelGate(gate_channels, reduction_ratio, pool_types[1], flag=flag)
        else:
            self.ChannelGateW = ChannelGate(gate_channels, reduction_ratio, pool_types[0])
            # self.ChannelGateH = ChannelGate(gate_channels, reduction_ratio, pool_types[1])

        self.skip1 = nn.Conv2d(gate_channels, gate_channels, 1, stride=1, padding=0)
        # self.skip2 = nn.Conv2d(gate_channels, gate_channels, 1, stride=1, padding=0)

    def forward(self, x):
        x_out = self.ChannelGateW(x)
        x_out = x_out + self.skip1(x)
        # x_out = self.ChannelGateH(x_out)
        # x_out = x_out + self.skip2(x)

        return x_out


class HWAM(nn.Module):
    def __init__(self, gate_channels, reduction_ratio=16, pool_types=['avgW', 'avgH'], flag=False):
        super(HWAM, self).__init__()
        if flag:
            self.ChannelGateW = ChannelGate(gate_channels, reduction_ratio, pool_types[0], flag=flag)
            self.ChannelGateH = ChannelGate(gate_channels, reduction_ratio, pool_types[1], flag=flag)
        else:
            self.ChannelGateW = ChannelGate(gate_channels, reduction_ratio, pool_types[0])
            self.ChannelGateH = ChannelGate(gate_channels, reduction_ratio, pool_types[1])

        # self.skip1 = nn.Conv2d(gate_channels, gate_channels, 1, stride=1, padding=0)
        # self.skip2 = nn.Conv2d(gate_channels, gate_channels, 1, stride=1, padding=0)

    def forward(self, x):
        x_out = self.ChannelGateW(x)
        x_out = self.ChannelGateH(x_out)
        # x_out = x_out + self.skip2(x)

        return x_out


